<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="gardenMapper">

	<resultMap type="com.uni.spring.garden.model.dto.VisitorBoard" id="VBoardResultSet"> 
		<id property="boardNo" column="BOARD_NO"/>
		<result property="writer" column="USER_ID" />		
		<result property="hostUser" column="HOST_USER" />
		<result property="content" column="CONTENT" />
		<result property="enrollDate" column="ENROLL_DATE" />	
		<result property="status" column="STATUS" />
	</resultMap>

	
	<select id="getBoardList" parameterType="string" resultMap="VBoardResultSet">
		
		<![CDATA[
		SELECT *
		FROM (
			SELECT A.BOARD_NO, B.USER_ID, A.HOST_USER, A.CONTENT, A.ENROLL_DATE, A.STATUS
			FROM VISITOR_BOARD A
			JOIN MEMBER B ON A.WRITER = B.USER_NO
			WHERE A.HOST_USER = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
			AND A.STATUS='Y'
			ORDER BY A.BOARD_NO DESC)
		WHERE ROWNUM <= 3
		]]>
	
	</select>
	
	<select id="selectListCount" resultType="_int">
	
		SELECT COUNT(*)
		FROM VISITOR_BOARD
		WHERE HOST_USER = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
		AND STATUS = 'Y'
	
	</select>
	
	<select id="getBoardListAll" resultMap="VBoardResultSet">
	
		SELECT *
		FROM (
			SELECT A.BOARD_NO, B.USER_ID, A.HOST_USER, A.CONTENT, A.ENROLL_DATE, A.STATUS
			FROM VISITOR_BOARD A
			JOIN MEMBER B ON A.WRITER = B.USER_NO
			WHERE A.HOST_USER = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
			AND A.STATUS='Y'
			ORDER BY A.BOARD_NO DESC)
	
	</select>
	
	<insert id="insertBoard">
	
		INSERT INTO VISITOR_BOARD VALUES
		(SEQ_V_BOARD_NO.NEXTVAL, #{writer}, (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser}), #{content}, DEFAULT, DEFAULT)
		
	</insert>
	
	<update id="deleteBoard">
	
		UPDATE VISITOR_BOARD
		SET STATUS = 'N'
		WHERE BOARD_NO = #{boardNo}
		
	</update>
	
	<update id="updateBoard">
	
		UPDATE VISITOR_BOARD
		SET CONTENT = #{content}
		WHERE BOARD_NO = #{boardNo}
		
	</update>
	
	<!-- 방명록 댓글 -->
	
	<resultMap type="VComment" id="VCommentResultSet"> 
		<id property="commentNo" column="COMMENT_NO"/>
		<result property="boardNo" column="BOARD_NO"/>
		<result property="userNo" column="USER_ID" />		
		<result property="comment" column="COMMENT" />
		<result property="enrollDate" column="ENROLL_DATE" />	
		<result property="status" column="STATUS" />
	</resultMap>

	<!-- 댓글 -->
	
	<insert id="insertComment">
	
		INSERT INTO VISITOR_COMMENT VALUES
		(SEQ_V_COMMENT_NO.NEXTVAL, #{boardNo}, #{userNo}, #{content}, DEFAULT, DEFAULT)

	</insert>
	
	<select id="selectCommentCount" resultType="_int">
	
		<!-- SELECT COUNT(*)
		FROM VISITOR_COMMENT
		WHERE USER_NO = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
		AND STATUS = 'Y' -->
		
		SELECT COUNT(*)
	    FROM VISITOR_COMMENT A
	    JOIN MEMBER B ON A.USER_NO = B.USER_NO
	    JOIN VISITOR_BOARD C ON A.BOARD_NO = C.BOARD_NO
	    WHERE C.HOST_USER = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
	    AND A.STATUS='Y'
	
	</select>
	
	<select id="selectCommentList" resultMap="VCommentResultSet">
	
		<!-- SELECT *
		FROM (
		    SELECT A.COMMENT_NO, A.BOARD_NO, B.USER_ID, A.CONTENT, A.ENROLL_DATE, A.STATUS
		    FROM VISITOR_COMMENT A
		    JOIN MEMBER B ON A.USER_NO = B.USER_NO
		    WHERE A.USER_NO = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
		    AND A.STATUS='Y'
		    ORDER BY A.BOARD_NO DESC) -->
		    
		SELECT A.COMMENT_NO, A.BOARD_NO, B.USER_ID, A.CONTENT, A.ENROLL_DATE, A.STATUS
	    FROM VISITOR_COMMENT A
	    JOIN MEMBER B ON A.USER_NO = B.USER_NO
	    JOIN VISITOR_BOARD C ON A.BOARD_NO = C.BOARD_NO
	    WHERE C.HOST_USER = (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{hostUser})
	    AND A.STATUS='Y'
	    ORDER BY A.BOARD_NO DESC, A.ENROLL_DATE DESC   
	
	</select>
	
	<update id="updateComment">
	
		UPDATE VISITOR_COMMENT
		SET CONTENT = #{content}, ENROLL_DATE = SYSDATE
		WHERE COMMENT_NO = #{commentNo}
		
	</update>
	
	<update id="deleteComment">
	
		UPDATE VISITOR_COMMENT
		SET STATUS = 'N'
		WHERE COMMENT_NO = #{commentNo}
		
	</update>
	
	
	
	<!-- 이웃관리 -->
	
	<resultMap type="Neighbor" id="NeighborResultSet"> 
		<id property="neighborNo" column="NEIGHBOR_NO"/>
		<result property="userNo" column="USER_NO" />		
		<result property="nUserNo" column="USER_ID" />
		<result property="enrollDate" column="ENROLL_DATE" />	
		<result property="status" column="STATUS" />
	</resultMap>
	
	<select id="getNeighborList" resultMap="NeighborResultSet">
	
		SELECT A.NEIGHBOR_NO, B.USER_ID, A.ENROLL_DATE, A.STATUS
		FROM NEIGHBOR A
		JOIN MEMBER B ON A.N_USER_NO = B.USER_NO
		WHERE A.USER_NO = #{userNo}
		AND A.STATUS = 'Y'
		ORDER BY A.ENROLL_DATE DESC
	
	</select>
	
	<update id="deleteNeighbor">
	
		UPDATE NEIGHBOR
		SET STATUS = 'N'
		WHERE NEIGHBOR_NO = #{neighborNo}
		
	</update>
	
	<insert id="insertNeighbor">
	
		INSERT INTO NEIGHBOR VALUES
		(SEQ_NEIGHBOR_NO.NEXTVAL, #{userNo}, (SELECT USER_NO FROM MEMBER WHERE USER_ID = #{nUserId}), DEFAULT, DEFAULT)
	
	</insert>
</mapper>